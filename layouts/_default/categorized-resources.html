{{ define "main" }}
  <main class="content page-template page-{{ .Slug }}">
    <article class="post page">
      <header class="post-header">
        {{ if .Parent.IsHome }}
          {{ partial "back-home.html" . }}
        {{ else }}
          {{ with .Parent }}
            <a id="back-to-main-page" href="{{ .RelPermalink | relLangURL }}"><i class="fa fa-chevron-left" aria-hidden="true"></i> {{ .Title }}</a>
          {{ end }}
        {{ end }}
      </header>
      <h1 class="post-title">{{ (or .Params.display_title .Title) | emojify | safeHTML }}</h1>
      <section class="post-content">
        {{ .Content }}

        {{/* --- Category & Post Listing Logic --- */}}

        {{/* Get all regular pages in the current section */}}
        {{ $pages := .RegularPages }}
        
        {{/* Collect all unique categories from these pages */}}
        {{ $categories := slice }}
        {{ range $pages }}
          {{ range .Params.categories }}
            {{ $categories = $categories | append . }}
          {{ end }}
        {{ end }}
        {{ $categories = $categories | uniq | sort }}

        {{/* Loop through each unique category */}}
        {{ range $cat := $categories }}
            <section class="category-section">
              <h3>{{ $cat }}</h3>
              <ul>
                {{/* Filter pages that have this category */}}
                {{ range $pages }}
                  {{ if in .Params.categories $cat }}
                    <li>
                      <a href="{{ .Permalink }}">{{ .Title }}</a>
                    </li>
                  {{ end }}
                {{ end }}
              </ul>
            </section>
        {{ end }}
      </section>
    </article>
  </main>
{{ end }}
